<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Check-in</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      :root{
        --bg:#f7f7f8; --card:#ffffff; --muted:#666;
        --border:#e5e7eb; --text:#111;
        --focus:#111; --danger-bg:#d32f2f;
        --ring: 0 0 0 3px rgba(0,0,0,.08);
        --radius: 14px;
      }
      html, body { height:100%; }
      body { margin:0; padding:16px; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
      .container { max-width: 820px; margin: 0 auto; }
      h2 { margin: 8px 4px 16px; font-weight: 800; letter-spacing: .2px; }
      .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 6px 24px rgba(0,0,0,.06); padding:18px; }
      .row { display:grid; gap:14px; grid-template-columns:1fr 1fr; }
      @media (max-width:700px){ .row{ grid-template-columns:1fr; } }
      label { font-size:14px; color:#444; margin:6px 0 8px; display:block; }
      input, select { width:100%; appearance:none; background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px 14px; outline:none; transition:border-color .15s, box-shadow .15s; }
      input:focus, select:focus { border-color:var(--focus); box-shadow:var(--ring); }
      .actions { display:flex; align-items:center; gap:10px; margin-top:12px; }
      button { border:0; border-radius:999px; padding:12px 18px; cursor:pointer; transition:transform .05s, box-shadow .15s, opacity .2s; }
      .primary { background:#111; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.15); }
      .primary:disabled { opacity:.6; cursor:not-allowed; }
      .secondary { background:#f3f4f6; color:#111; }
      .status { margin-top:16px; padding:14px 16px; border:0; border-radius:12px; font-weight:700; display:none; }
      .status.error { background: var(--danger-bg); color:#fff; }
      .muted { color:var(--muted); font-size:12px; margin:10px 2px 0; }
      .help { font-size:12px; color:#888; margin-top:6px; }
      .invalid { border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.15) !important; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Check-in</h2>
      <div class="card">
        <div id="form-manual">
          <div class="row">
            <div>
              <label>H·ªç v√† t√™n <span class="muted">(b·∫Øt bu·ªôc)</span></label>
              <input id="fullName" placeholder="Nguy·ªÖn VƒÉn A" />
            </div>
            <div>
              <label>C√¥ng vi·ªác <span class="muted">(t√πy ch·ªçn)</span></label>
              <input id="job" placeholder="K·ªπ s∆∞, Gi√°o vi√™n..." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ƒê∆°n v·ªã c√¥ng t√°c <span class="muted">(b·∫Øt bu·ªôc)</span></label>
              <input id="org" placeholder="C√¥ng ty ABC" />
            </div>
            <div>
              <label>Nh√≥m kh√°ch <span class="muted">(b·∫Øt bu·ªôc)</span></label>
              <select id="group">
                <option>üî¥ Ban t·ªï ch·ª©c / Organizer</option>
                <option>üü° Keynote / Keynote Speaker</option>
                <option>üü† B√°o c√°o vi√™n / Presenter</option>
                <option selected>üîµ Kh√°ch tham d·ª± / Participant</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Email <span class="muted">(b·∫Øt bu·ªôc)</span></label>
              <input id="email" type="email" placeholder="email@domain.com" />
              <div id="emailHelp" class="help" style="display:none;">Email kh√¥ng h·ª£p l·ªá.</div>
            </div>
            <div>
              <label>S·ªë ƒëi·ªán tho·∫°i <span class="muted">(t√πy ch·ªçn)</span></label>
              <input id="phone" inputmode="tel" placeholder="0xxxxxxxxx ho·∫∑c +84xxxxxxxxx" />
              <div id="phoneHelp" class="help" style="display:none;">Ch·ªâ nh·∫≠p s·ªë (ch·∫•p nh·∫≠n +84). 9‚Äì11 ch·ªØ s·ªë.</div>
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="btnManual">Check-in</button>
            <button class="secondary" id="btnClear">X√≥a</button>
          </div>
        </div>

        <div id="status" class="status"></div>
      </div>

      <p class="muted">ID s·∫Ω t·ª± tƒÉng (G001, G002, ‚Ä¶). M√†u nh√≥m ƒë∆∞·ª£c t√¥ v√†o c·ªôt ri√™ng trong Sheet.</p>
    </div>

    <script>
      const statusEl = document.getElementById('status');

      // T√≠nh m√†u ch·ªØ tr·∫Øng/ƒëen theo n·ªÅn (cho d·ªÖ ƒë·ªçc)
      function textColorFor(bgHex){
        const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(bgHex || '');
        if (!m) return '#fff';
        const r = parseInt(m[1],16), g = parseInt(m[2],16), b = parseInt(m[3],16);
        const yiq = (r*299 + g*587 + b*114) / 1000;
        return yiq >= 160 ? '#111' : '#fff';
      }

      function showStatus(result) {
        statusEl.className = 'status';
        if (result?.ok) {
          const bg = result.color || '#1e90ff';
          statusEl.style.background = bg;
          statusEl.style.color = textColorFor(bg);
        } else {
          statusEl.classList.add('error');
          statusEl.style.color = '#fff';
        }
        statusEl.style.display = 'block';
        statusEl.textContent = result?.message || '‚Äî';
      }
      function showError(msg){ showStatus({ ok:false, message:msg }); }

      // ==== Frontend validation ====
      function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
      function normalizePhone(v){
        const digits = String(v || '').replace(/\D/g, '');
        if (!digits) return { ok:false, msg:'', value:'' }; // cho ph√©p b·ªè tr·ªëng
        let n = digits;
        if (n.startsWith('84')) n = '0' + n.slice(2);
        if (!n.startsWith('0')) n = '0' + n;
        if (n.length < 9 || n.length > 11) return { ok:false, msg:'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (9‚Äì11 ch·ªØ s·ªë).' };
        if (!/^\d+$/.test(n)) return { ok:false, msg:'S·ªë ƒëi·ªán tho·∫°i ch·ªâ ch·ª©a ch·ªØ s·ªë.' };
        return { ok:true, value:n };
      }
      function markInvalid(el, helpEl, msg){
        if (helpEl && msg){ helpEl.textContent = msg; helpEl.style.display = 'block'; }
        el.classList.add('invalid');
      }

      const btnManual = document.getElementById('btnManual');
      const btnClear  = document.getElementById('btnClear');

      btnManual.addEventListener('click', () => {
        const fullNameEl = document.getElementById('fullName');
        const jobEl      = document.getElementById('job');
        const orgEl      = document.getElementById('org');
        const groupEl    = document.getElementById('group');
        const emailEl    = document.getElementById('email');
        const phoneEl    = document.getElementById('phone');

        const fullName = fullNameEl.value.trim();
        const job      = jobEl.value.trim();          // tu·ª≥ ch·ªçn
        const org      = orgEl.value.trim();
        const group    = groupEl.value.trim();
        const email    = emailEl.value.trim();
        const phone    = phoneEl.value.trim();        // tu·ª≥ ch·ªçn

        // reset state
        [fullNameEl, jobEl, orgEl, emailEl, phoneEl].forEach(e => e.classList.remove('invalid'));
        document.getElementById('emailHelp').style.display = 'none';
        document.getElementById('phoneHelp').style.display = 'none';

        if (!fullName){ markInvalid(fullNameEl); return showError('Vui l√≤ng nh·∫≠p H·ªç v√† t√™n.'); }
        if (!org){      markInvalid(orgEl);      return showError('Vui l√≤ng nh·∫≠p ƒê∆°n v·ªã c√¥ng t√°c.'); }
        if (!group){                             return showError('Vui l√≤ng ch·ªçn Nh√≥m kh√°ch.'); }
        if (!email || !isValidEmail(email)){
          markInvalid(emailEl, document.getElementById('emailHelp'), 'Email kh√¥ng h·ª£p l·ªá.');
          return showError('Email kh√¥ng h·ª£p l·ªá.');
        }

        // phone: ch·ªâ validate n·∫øu c√≥ nh·∫≠p
        let phoneValue = '';
        if (phone){
          const ph = normalizePhone(phone);
          if (!ph.ok){
            markInvalid(phoneEl, document.getElementById('phoneHelp'), ph.msg);
            return showError(ph.msg);
          }
          phoneValue = ph.value;
        }

        // OK ‚Üí g·ª≠i server
        const data = { fullName, job, org, group, email, phone: phoneValue };
        btnManual.disabled = true; btnManual.textContent = 'ƒêang ghi...';

        google.script.run
          .withSuccessHandler(res => { showStatus(res); btnManual.disabled=false; btnManual.textContent='Check-in'; })
          .withFailureHandler(err => { showError(err?.message || 'C√≥ l·ªói khi g·ªçi server.'); btnManual.disabled=false; btnManual.textContent='Check-in'; })
          .checkIn(data);
      });

      btnClear.addEventListener('click', () => {
        ['fullName','job','org','email','phone'].forEach(i => document.getElementById(i).value = '');
        document.getElementById('group').value = 'üîµ Kh√°ch tham d·ª± / Participant';
        statusEl.style.display = 'none';
        statusEl.className = 'status';
        ;['fullName','job','org','email','phone'].forEach(i => document.getElementById(i).classList.remove('invalid'));
        document.getElementById('emailHelp').style.display = 'none';
        document.getElementById('phoneHelp').style.display = 'none';
      });

      // Enter-to-submit
      ['fullName','job','org','email','phone'].forEach(i => {
        document.getElementById(i).addEventListener('keydown', e => { if (e.key === 'Enter') btnManual.click(); });
      });
    </script>
  </body>
</html>
